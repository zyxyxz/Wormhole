<navigation-bar title="房间详情" back="{{true}}" bind:back="goBack" home-button="{{false}}" />

<view class="page">
  <view class="hero-card">
    <view class="hero-title">{{space.code || space.space_id}}@{{space.owner_alias || space.owner_user_id || '未设置'}}</view>
    <view class="hero-sub">空间ID {{space.space_id || '-'}} · 创建 {{space.created_at_bj || space.created_at || '-'}}</view>
    <view class="hero-actions">
      <button size="mini" class="ghost" bindtap="goLogs">查看日志</button>
    </view>
  </view>

  <view class="filter-card">
    <view class="filter-row">
      <view class="filter-left">
        <switch checked="{{includeDeleted}}" color="#2563EB" bindchange="onToggleIncludeDeleted" />
        <text class="filter-label">查看已删除内容</text>
      </view>
      <view class="filter-right">
        <text class="filter-label">显示</text>
        <input class="limit-input" type="number" value="{{limitInput}}" bindinput="onLimitInput" />
        <text class="filter-label">条</text>
        <button size="mini" class="ghost" bindtap="applyLimit">应用</button>
      </view>
    </view>
  </view>

  <view class="stat-grid">
    <view class="stat-item">
      <text class="stat-value">{{space.member_count || 0}}</text>
      <text class="stat-label">成员</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{space.message_count || 0}}</text>
      <text class="stat-label">消息</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{space.post_count || 0}}</text>
      <text class="stat-label">动态</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{space.note_count || 0}}</text>
      <text class="stat-label">笔记</text>
    </view>
  </view>

  <view class="section">
    <view class="section-title">成员（{{members.length}}）</view>
    <view class="card">
      <view class="member-row" wx:for="{{members}}" wx:key="user_id">
        <view class="member-main">
          <text class="member-name">{{item.alias || item.user_id || '匿名'}}</text>
          <text class="member-id">{{item.user_id}}</text>
        </view>
      </view>
      <view class="empty" wx:if="{{!members.length}}">暂无成员</view>
    </view>
  </view>

  <view class="section" wx:if="{{recentPosts.length}}">
    <view class="section-title">近期动态</view>
    <view class="card">
      <view class="activity" wx:for="{{recentPosts}}" wx:key="id">
        <view class="activity-meta">
          {{item.alias || item.user_id}} · {{item.created_at_bj || item.created_at}}
          <text wx:if="{{item.deleted_at}}" class="tag-deleted">已删除</text>
        </view>
        <view class="activity-content">{{item.content || (item.media_type==='image' ? '[图片]' : item.media_type==='video' ? '[视频]' : '[媒体]')}}</view>
        <view wx:if="{{item.media_type==='image' && item.media_urls && item.media_urls.length}}" class="media-grid">
          <image wx:for="{{item.media_urls}}" wx:for-item="imgSrc" wx:key="*this" class="media-image" mode="aspectFill" src="{{imgSrc}}" data-urls="{{item.media_urls}}" data-current="{{imgSrc}}" bindtap="previewImage" />
        </view>
        <video wx:if="{{item.media_type==='video' && item.media_urls && item.media_urls.length}}" class="media-video" src="{{item.media_urls[0]}}" controls></video>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{recentMessages.length}}">
    <view class="section-title">近期消息</view>
    <view class="card">
      <view class="activity" wx:for="{{recentMessages}}" wx:key="id">
        <view class="activity-meta">
          {{item.alias || item.user_id}} · {{item.created_at_bj || item.created_at}}
          <text wx:if="{{item.deleted_at}}" class="tag-deleted">已删除</text>
        </view>
        <view class="activity-content">{{item.content || (item.message_type==='image' ? '[图片]' : item.message_type==='video' ? '[视频]' : item.message_type==='audio' ? '[语音]' : '[媒体]')}}</view>
        <image wx:if="{{item.message_type==='image' && item.media_url}}" class="media-image single" mode="aspectFill" src="{{item.media_url}}" data-urls="{{[item.media_url]}}" data-current="{{item.media_url}}" bindtap="previewImage" />
        <video wx:if="{{item.message_type==='video' && item.media_url}}" class="media-video" src="{{item.media_url}}" controls></video>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{recentNotes.length}}">
    <view class="section-title">近期笔记</view>
    <view class="card">
      <view class="activity" wx:for="{{recentNotes}}" wx:key="id">
        <view class="activity-meta">
          {{item.alias || item.user_id}} · {{item.created_at_bj || item.created_at}}
          <text wx:if="{{item.deleted_at}}" class="tag-deleted">已删除</text>
        </view>
        <view class="activity-title">{{item.title || '无标题'}}</view>
        <view class="activity-content">{{item.content || '-'}}</view>
      </view>
    </view>
  </view>
</view>

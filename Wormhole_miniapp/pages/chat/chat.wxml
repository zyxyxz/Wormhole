<navigation-bar title="èŠå¤©" back="{{false}}" home-button="{{true}}" bind:home="goHome" background="#FFFFFF" color="#0F172A" />
<view class="chat-container">
  <scroll-view class="message-list" scroll-y="true" scroll-with-animation="true" scroll-into-view="{{lastMessageId}}" enable-flex="true" style="padding-bottom: {{bottomPadding}}px;">
    <view wx:for="{{messages}}" wx:key="id" class="message-item {{item.isSelf ? 'self' : ''}}" id="msg-{{item.id}}">
      <view class="avatar">
        <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill"></image>
        <text wx:else>{{item.initial}}</text>
      </view>
      <view class="message-content">
        <view class="nickname">{{item.nickname}}</view>
        <block wx:if="{{item.messageType === 'text'}}">
          <view class="message-bubble">{{item.content}}</view>
        </block>
        <block wx:elif="{{item.messageType === 'image'}}">
          <image class="message-image" src="{{item.mediaUrl}}" mode="aspectFill" bindtap="previewChatImage" data-url="{{item.mediaUrl}}"></image>
        </block>
        <block wx:elif="{{item.messageType === 'audio'}}">
          <view class="audio-bubble" data-url="{{item.mediaUrl}}" data-id="{{item.id}}" bindtap="playAudio">
            <text class="audio-icon">â™ª</text>
            <text>{{item.audioDuration || 0}}s</text>
            <text wx:if="{{audioPlayingId === item.id}}" class="playing">æ’­æ”¾ä¸­</text>
          </view>
        </block>
        <view class="message-time">{{item.displayTime}}</view>
      </view>
    </view>
  </scroll-view>

  <view class="input-area" style="bottom: {{keyboardHeight}}px;">
    <view class="input-row">
      <button class="tool-btn" bindtap="toggleInputMode">{{inputMode === 'text' ? 'ğŸ¤' : 'âŒ¨ï¸'}}</button>
      <block wx:if="{{inputMode === 'text'}}">
        <input class="message-input" 
               value="{{inputMessage}}"
               bindinput="onInputChange"
               bindfocus="onInputFocus"
               bindblur="onInputBlur"
               adjust-position="false"
               placeholder="è¾“å…¥æ¶ˆæ¯..."/>
      </block>
      <block wx:else>
        <view class="voice-button" bindtouchstart="handleRecordStart" bindtouchend="handleRecordEnd" bindtouchcancel="handleRecordCancel">
          {{recording ? 'æ¾å¼€å‘é€' : 'æŒ‰ä½è¯´è¯'}}
        </view>
      </block>
      <button class="send-button" wx:if="{{inputMode === 'text' && inputMessage}}" bindtap="sendMessage">å‘é€</button>
      <button class="plus-button" wx:else bindtap="openAttachmentMenu">ï¼‹</button>
    </view>
  </view>
</view> 

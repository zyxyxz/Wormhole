<navigation-bar title="èŠå¤©" back="{{false}}" home-button="{{true}}" bind:home="goHome" background="#FFFFFF" color="#0F172A">
  <view slot="right" class="nav-chips">
    <view class="nav-chip" bindtap="openMembers">äººæ•° {{memberCount}}</view>
    <view class="nav-chip online" bindtap="openOnline">åœ¨çº¿ {{onlineCount}}</view>
  </view>
</navigation-bar>
<view class="chat-container">
  <scroll-view class="message-list" scroll-y="true" scroll-with-animation="true" scroll-into-view="{{scrollTargetId}}" enable-flex="true" upper-threshold="80" bindscrolltoupper="loadOlderMessages" bindscrolltolower="onScrollToLower" bindscroll="onScroll" style="padding-bottom: {{bottomPadding}}px;">
    <view class="history-hint">
      <text wx:if="{{historyLoading}}">åŠ è½½ä¸­...</text>
      <text wx:elif="{{!historyHasMore}}">æ²¡æœ‰æ›´å¤šæ¶ˆæ¯</text>
      <text wx:else>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    <view wx:for="{{messages}}" wx:key="id">
      <view wx:if="{{item.showUnreadDivider}}" class="unread-divider">
        <text>ä»¥ä¸‹ä¸ºæœªè¯»æ¶ˆæ¯</text>
      </view>
      <view class="message-item {{item.isSelf ? 'self' : ''}}" id="msg-{{item.id}}"
            bindlongpress="startReply"
            data-id="{{item.id}}"
            data-user-id="{{item.userId}}"
            data-nickname="{{item.nickname}}"
            data-content="{{item.content}}"
            data-message-type="{{item.messageType}}">
      <view class="avatar">
        <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill"></image>
        <text wx:else>{{item.initial}}</text>
      </view>
      <view class="message-content">
        <view class="nickname">{{item.nickname}}</view>
        <view wx:if="{{item.reply}}" class="reply-snippet">
          <text class="reply-snippet-name">{{item.reply.nickname}}</text>
          <text class="reply-snippet-text">{{item.reply.content}}</text>
        </view>
        <block wx:if="{{item.messageType === 'text'}}">
          <view class="message-bubble">{{item.content}}</view>
        </block>
        <block wx:elif="{{item.messageType === 'image'}}">
          <image class="message-image" src="{{item.mediaUrl}}" mode="aspectFill" bindtap="previewChatImage" data-url="{{item.mediaUrl}}"></image>
        </block>
        <block wx:elif="{{item.messageType === 'audio'}}">
          <view class="audio-bubble" data-url="{{item.mediaUrl}}" data-id="{{item.id}}" bindtap="playAudio">
            <text class="audio-icon">â™ª</text>
            <text>{{item.audioDuration || 0}}s</text>
            <text wx:if="{{audioPlayingId === item.id}}" class="playing">æ’­æ”¾ä¸­</text>
          </view>
        </block>
        <view class="message-meta">
          <view class="message-time">{{item.displayTime}}</view>
          <view wx:if="{{item.isSelf && memberCount > 1}}" class="read-state" bindtap="openReadList" data-id="{{item.id}}">
            <text wx:if="{{item.readCount}}">å·²è¯» {{item.readCount}}</text>
            <text wx:else>æœªè¯»</text>
          </view>
        </view>
      </view>
    </view>
    </view>
    <view wx:if="{{typingDisplay.length}}" class="typing-row">
      <view class="typing-avatars">
        <view wx:for="{{typingDisplay}}" wx:key="user_id" class="typing-avatar">
          <image wx:if="{{item.avatar_url}}" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <text wx:else>{{item.initial}}</text>
        </view>
      </view>
      <text class="typing-text">æ­£åœ¨è¾“å…¥...</text>
    </view>
  </scroll-view>

  <view class="input-area" style="bottom: {{keyboardHeight}}px;">
    <view wx:if="{{replyingTo}}" class="reply-bar">
      <view class="reply-text">å›å¤ {{replyingTo.nickname}}ï¼š{{replyingTo.content}}</view>
      <view class="reply-cancel" bindtap="cancelReply">Ã—</view>
    </view>
    <view class="input-row">
      <button class="tool-btn" bindtap="toggleInputMode">{{inputMode === 'text' ? 'ğŸ¤' : 'âŒ¨ï¸'}}</button>
      <block wx:if="{{inputMode === 'text'}}">
        <input class="message-input" 
               value="{{inputMessage}}"
               bindinput="onInputChange"
               bindfocus="onInputFocus"
               bindblur="onInputBlur"
               adjust-position="false"
               placeholder="è¾“å…¥æ¶ˆæ¯..."/>
      </block>
      <block wx:else>
        <view class="voice-button" bindtouchstart="handleRecordStart" bindtouchend="handleRecordEnd" bindtouchcancel="handleRecordCancel">
          {{recording ? 'æ¾å¼€å‘é€' : 'æŒ‰ä½è¯´è¯'}}
        </view>
      </block>
      <button class="send-button" wx:if="{{inputMode === 'text' && inputMessage}}" bindtap="sendMessage">å‘é€</button>
      <button class="plus-button" wx:if="{{!(inputMode === 'text' && inputMessage)}}" bindtap="openAttachmentMenu">ï¼‹</button>
      <button class="emoji-button" wx:if="{{inputMode === 'text'}}" bindtap="toggleEmojiPanel">ğŸ˜Š</button>
    </view>
    <view wx:if="{{emojiPanelVisible}}" class="emoji-panel">
      <view class="emoji-grid">
        <text wx:for="{{emojiList}}" wx:key="*this" class="emoji-item" data-emoji="{{item}}" bindtap="addEmoji">{{item}}</text>
      </view>
    </view>
  </view>
</view>

<view wx:if="{{showMemberModal}}" class="modal-mask" bindtap="closeMembers">
  <view class="modal-card" catchtap="noop">
    <view class="modal-title">æˆå‘˜ ({{memberCount}})</view>
    <scroll-view class="modal-list" scroll-y="true">
      <view wx:for="{{members}}" wx:key="user_id" class="modal-item">
        <view class="modal-avatar">
          <image wx:if="{{item.avatar_url}}" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <text wx:else>{{item.initial}}</text>
        </view>
        <view class="modal-name">{{item.displayName}}</view>
      </view>
    </scroll-view>
  </view>
</view>

<view wx:if="{{showOnlineModal}}" class="modal-mask" bindtap="closeOnline">
  <view class="modal-card" catchtap="noop">
    <view class="modal-title">åœ¨çº¿ ({{onlineCount}})</view>
    <scroll-view class="modal-list" scroll-y="true">
      <view wx:for="{{onlineMembers}}" wx:key="user_id" class="modal-item">
        <view class="modal-avatar">
          <image wx:if="{{item.avatar_url}}" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <text wx:else>{{item.initial}}</text>
        </view>
        <view class="modal-name">{{item.displayName}}</view>
      </view>
      <view wx:if="{{!onlineMembers.length}}" class="modal-empty">æš‚æ— åœ¨çº¿</view>
    </scroll-view>
  </view>
</view>

<view wx:if="{{showReadModal}}" class="modal-mask" bindtap="closeReadModal">
  <view class="modal-card" catchtap="noop">
    <view class="modal-title">å·²è¯»æˆå‘˜</view>
    <scroll-view class="modal-list" scroll-y="true">
      <view wx:for="{{readModalUsers}}" wx:key="user_id" class="modal-item">
        <view class="modal-avatar">
          <image wx:if="{{item.avatar_url}}" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <text wx:else>{{item.initial}}</text>
        </view>
        <view class="modal-name">{{item.displayName}}</view>
      </view>
      <view wx:if="{{!readModalUsers.length}}" class="modal-empty">æš‚æ— å·²è¯»</view>
    </scroll-view>
  </view>
</view>

<navigation-bar title="设置" back="{{false}}" home-button="{{true}}" bind:home="goHome" background="{{themeNavBg}}" color="{{themeNavText}}" />
<view class="settings-container theme-root {{themeClass}}">
  <scroll-view class="settings-scroll" scroll-y="true">
    <view class="room-card">
      <view class="room-card-header">
        <view class="avatar-circle" bindtap="chooseAvatar">
          <image wx:if="{{avatarUrl}}" src="{{avatarUrl}}" mode="aspectFill"></image>
          <text wx:else>{{aliasInitial}}</text>
        </view>
        <view class="room-card-info">
          <view class="alias-row">
            <text class="alias-text">{{alias || '未设置'}}</text>
            <button class="icon-button" size="mini" bindtap="openAliasModal">编辑</button>
          </view>
          <view class="code-row">
            <text class="code-text">空间号 {{spaceCode}}</text>
            <button class="link-button" wx:if="{{isOwner}}" bindtap="modifySpaceCode">修改</button>
          </view>
        </view>
      </view>
      <view class="room-card-meta">
        <view class="meta-item interactive" bindtap="openMembersModal">
          <text class="meta-label">成员</text>
          <view class="member-avatars">
            <view class="avatar-mini" wx:for="{{memberPreview}}" wx:key="user_id">
              <image wx:if="{{item.avatar_url}}" src="{{item.avatar_url}}" mode="aspectFill"></image>
              <text wx:else>{{item.initial}}</text>
            </view>
            <text class="meta-count">{{members.length}}人</text>
          </view>
        </view>
        <view class="meta-item">
          <text class="meta-label">我的身份</text>
          <text class="meta-value">{{isOwner ? '房主' : '成员'}}</text>
        </view>
      </view>
    </view>
    <view class="settings-group">
      <view class="settings-item" wx:if="{{isOwner}}" bindtap="shareSpace">
        <text>分享空间</text>
        <text class="arrow">></text>
      </view>

      <view class="settings-item" bindtap="deleteSpace">
        <text>删除空间</text>
        <text class="arrow">></text>
      </view>

      <picker mode="selector" range="{{autoLockOptions}}" value="{{autoLockIndex}}" bindchange="onAutoLockChange">
        <view class="settings-item">
          <text>无操作锁定时间</text>
          <view class="settings-item-right">
            <text class="space-code">{{autoLockOptions[autoLockIndex]}}</text>
            <text class="arrow">></text>
          </view>
        </view>
      </picker>

      <picker mode="selector" range="{{themeOptions}}" value="{{themeIndex}}" bindchange="onThemeChange">
        <view class="settings-item">
          <text>主题模式</text>
          <view class="settings-item-right">
            <text class="space-code">{{themeOptions[themeIndex]}}</text>
            <text class="arrow">></text>
          </view>
        </view>
      </picker>

      <view class="settings-item">
        <text>离开小程序自动锁定</text>
        <switch checked="{{autoLockOnHide}}" color="#14B8A6" bindchange="toggleAutoLockOnHide" />
      </view>
    </view>

    <view class="settings-group" wx:if="{{isOwner}}">
      <view class="settings-item">
        <text>黑名单（房主）</text>
      </view>
      <view class="member-item" wx:for="{{blocks}}" wx:key="user_id">
        <text>{{item.alias || item.user_id}}</text>
        <button size="mini" bindtap="unblockMember" data-userid="{{item.user_id}}">取消拉黑</button>
      </view>
    </view>
  </scroll-view>
</view>

<!-- 修改空间号弹窗 -->
<view class="modal" wx:if="{{showModifyModal}}">
  <view class="modal-content">
    <view class="modal-title">修改空间号</view>
    <input class="space-input" 
           type="number" 
           maxlength="6" 
           value="{{newSpaceCode}}"
           bindinput="onSpaceCodeInput"
           placeholder="请输入6位数字"/>
    <view class="modal-buttons">
      <button class="cancel-button" bindtap="cancelModify">取消</button>
      <button class="confirm-button" bindtap="confirmModify">确定</button>
    </view>
  </view>
</view>

<!-- 分享弹窗 -->
<view class="modal" wx:if="{{showShareModal}}">
  <view class="modal-content">
    <view class="modal-title">分享口令</view>
    <view class="share-code">{{shareCode}}</view>
    <view class="share-hint">{{shareInfoText}}</view>
    <button class="copy-button" bindtap="copyShareCode">复制口令</button>
    <button class="close-button" bindtap="closeShareModal">关闭</button>
  </view>
</view> 

<!-- 别名弹窗 -->
<view class="modal" wx:if="{{showAliasModal}}">
  <view class="modal-content">
    <view class="modal-title">设置房间内别名</view>
    <input class="space-input" maxlength="20" value="{{newAlias}}" bindinput="onAliasInput" placeholder="输入别名"/>
    <view class="modal-buttons">
      <button class="cancel-button" bindtap="closeAliasModal">取消</button>
      <button class="confirm-button" bindtap="confirmAlias">确定</button>
    </view>
  </view>
</view>

<!-- 成员列表弹窗 -->
<view class="modal" wx:if="{{showMembersModal}}">
  <view class="modal-content members-modal">
    <view class="modal-title">成员（{{members.length}}人）</view>
    <scroll-view class="members-scroll" scroll-y="true">
      <view class="member-row" wx:for="{{members}}" wx:key="user_id">
        <view class="member-avatar">
          <image wx:if="{{item.avatar_url}}" src="{{item.avatar_url}}" mode="aspectFill"></image>
          <text wx:else>{{item.initial}}</text>
        </view>
        <view class="member-info">
          <text class="member-name">{{item.displayName || item.user_id}}</text>
          <text class="member-id">{{item.user_id}}</text>
        </view>
        <view class="member-actions" wx:if="{{isOwner && item.user_id !== ownerUserId}}">
          <button size="mini" bindtap="removeMember" data-userid="{{item.user_id}}">移除</button>
          <button size="mini" type="warn" bindtap="blockMember" data-userid="{{item.user_id}}">拉黑</button>
        </view>
      </view>
    </scroll-view>
    <button class="close-button" bindtap="closeMembersModal">关闭</button>
  </view>
</view>

<!-- 删除空间确认弹窗 -->
<view class="modal" wx:if="{{showDeleteModal}}">
  <view class="modal-content">
    <view class="modal-title">确认删除空间</view>
    <view class="share-hint">请输入：{{deleteConfirmPhrase}}</view>
    <input class="space-input"
           value="{{deleteConfirmInput}}"
           bindinput="onDeleteConfirmInput"
           placeholder="输入确认文字" />
    <view class="modal-buttons">
      <button class="cancel-button" bindtap="closeDeleteModal">取消</button>
      <button class="confirm-button" bindtap="confirmDeleteSpace">确认删除</button>
    </view>
  </view>
</view>

<navigation-bar title="超级管理" back="{{true}}" bind:back="goBack" home-button="{{false}}" />

<view class="admin-placeholder" wx:if="{{loading}}">加载中...</view>
<view class="admin-placeholder" wx:elif="{{!loading && !hasAccess}}">无权限</view>

<scroll-view wx:elif="{{hasAccess}}" class="admin-scroll" scroll-y="true">
  <view class="admin-container">
    <view class="meta-card">
        <view class="meta-head">
          <view>
            <text class="meta-title">管理员通道</text>
            <text class="meta-desc">当前口令：{{adminRoomCode}}</text>
          </view>
          <view class="meta-actions">
            <button size="mini" class="refresh-btn" bindtap="refreshData">刷新</button>
            <button size="mini" class="refresh-btn danger" bindtap="cleanIdleSpaces">清理空房</button>
          </view>
        </view>
      </view>

    <view class="section">
      <view class="section-title">过审模式</view>
      <view class="review-row">
        <text>仅保留日记功能</text>
        <switch checked="{{reviewMode}}" bindchange="toggleReviewMode" color="#14B8A6" />
      </view>
    </view>

    <view class="stats-card">
      <view class="stat-item {{activeSection === 'users' ? 'active' : ''}}" data-section="users" bindtap="onStatTap">
        <text class="stat-value">{{overview.users || 0}}</text>
        <text class="stat-label">别名用户</text>
      </view>
      <view class="stat-item {{activeSection === 'spaces' ? 'active' : ''}}" data-section="spaces" bindtap="onStatTap">
        <text class="stat-value">{{overview.spaces || 0}}</text>
        <text class="stat-label">空间总数</text>
      </view>
      <view class="stat-item {{activeSection === 'messages' ? 'active' : ''}}" data-section="messages" bindtap="onStatTap">
        <text class="stat-value">{{overview.messages || 0}}</text>
        <text class="stat-label">消息</text>
      </view>
      <view class="stat-item {{activeSection === 'posts' ? 'active' : ''}}" data-section="posts" bindtap="onStatTap">
        <text class="stat-value">{{overview.posts || 0}}</text>
        <text class="stat-label">动态</text>
      </view>
    </view>

    <view class="section" wx:if="{{activeSection === 'spaces'}}">
      <view class="section-title">空间列表</view>
      <view class="space-filter" wx:if="{{spaceOwnerFilter}}">
        <text>筛选房主：{{spaceOwnerFilter}}</text>
        <button size="mini" class="refresh-btn" bindtap="clearSpaceFilter">清除筛选</button>
      </view>
      <view wx:if="{{spaceList.length}}">
        <view class="space-card" wx:for="{{spaceList}}" wx:key="space_id">
          <view class="space-head">
            <view>
              <text class="space-code">房间号 {{item.code}}@{{item.owner_alias || item.owner_user_id || '未设置'}}</text>
            </view>
            <view class="space-actions">
              <button size="mini" data-id="{{item.space_id}}" bindtap="openSpaceDetail">详情</button>
              <button size="mini" data-id="{{item.space_id}}" data-code="{{item.code}}" data-owner="{{item.owner_alias || item.owner_user_id || '未设置'}}" bindtap="openSpaceLogs">日志</button>
            </view>
          </view>
          <view class="space-stats">
            <text>成员 {{item.member_count}}</text>
            <text>消息 {{item.message_count}}</text>
            <text>动态 {{item.post_count}}</text>
            <text>笔记 {{item.note_count}}</text>
          </view>
        </view>
      </view>
      <view class="section-empty" wx:if="{{!spaceList.length}}">暂无空间</view>
    </view>

    <view class="section" wx:if="{{activeSection === 'users'}}">
      <view class="section-title">别名用户</view>
      <view wx:if="{{users.length}}">
        <view class="user-row" wx:for="{{users}}" wx:key="user_id">
          <view>
            <text class="user-alias">{{item.alias || '未命名'}}</text>
            <text class="user-id">{{item.user_id}}</text>
          </view>
          <view class="user-actions">
            <button size="mini" bindtap="viewSpaces" data-userid="{{item.user_id}}">房间</button>
            <button size="mini" bindtap="openUserLogs" data-userid="{{item.user_id}}" data-alias="{{item.alias || ''}}">日志</button>
          </view>
        </view>
      </view>
      <view class="section-empty" wx:if="{{!users.length}}">暂无用户</view>
    </view>

    <view class="section" wx:if="{{activeSection === 'messages'}}">
      <view class="section-title">最近消息</view>
      <view class="section-empty" wx:if="{{messagesLoading}}">加载中...</view>
      <view wx:if="{{!messagesLoading && recentMessages.length}}">
        <view class="activity-row" wx:for="{{recentMessages}}" wx:key="id">
          <text class="activity-meta">
            {{item.alias || item.user_id}} · 房间号 {{item.space_code || item.space_id}}@{{item.space_owner_alias || item.space_owner_id || '未设置'}} · {{item.created_at}}
          </text>
          <text class="activity-content">{{item.content || '[媒体]'}}</text>
        </view>
      </view>
      <view class="section-empty" wx:if="{{!messagesLoading && !recentMessages.length}}">暂无消息</view>
    </view>

    <view class="section" wx:if="{{activeSection === 'posts'}}">
      <view class="section-title">最近动态</view>
      <view class="section-empty" wx:if="{{postsLoading}}">加载中...</view>
      <view wx:if="{{!postsLoading && recentPosts.length}}">
        <view class="activity-row" wx:for="{{recentPosts}}" wx:key="id">
          <text class="activity-meta">
            {{item.alias || item.user_id}} · 房间号 {{item.space_code || item.space_id}}@{{item.space_owner_alias || item.space_owner_id || '未设置'}} · {{item.created_at}}
          </text>
          <text class="activity-content">{{item.content || '[媒体]'}}</text>
        </view>
      </view>
      <view class="section-empty" wx:if="{{!postsLoading && !recentPosts.length}}">暂无动态</view>
    </view>
  </view>
</scroll-view>

<view class="modal" wx:if="{{showSpaceModal}}">
  <view class="modal-content space-modal">
    <view class="modal-title">房间详情</view>
    <view class="modal-meta">
      <text>房间号：{{spaceDetail.code}}@{{spaceDetail.owner_alias || spaceDetail.owner_user_id || '未设置'}}</text>
      <text>创建：{{spaceDetail.created_at}}</text>
    </view>
    <view class="modal-stats">
      <text>成员 {{spaceDetail.member_count}}</text>
      <text>消息 {{spaceDetail.message_count}}</text>
      <text>动态 {{spaceDetail.post_count}}</text>
      <text>笔记 {{spaceDetail.note_count}}</text>
    </view>
    <view class="modal-section">
      <view class="modal-section-head">成员（{{spaceMembers.length}}）</view>
      <view class="member-row" wx:for="{{spaceMembers}}" wx:key="user_id">
        <text class="member-name">{{item.alias || item.user_id}}</text>
        <text class="member-id">{{item.user_id}}</text>
      </view>
    </view>
    <view class="modal-section" wx:if="{{spaceRecentPosts.length}}">
      <view class="modal-section-head">近期动态</view>
      <view class="feed-row" wx:for="{{spaceRecentPosts}}" wx:key="id">
        <text class="feed-meta">{{item.alias || item.user_id}} · {{item.created_at}}</text>
        <text class="feed-content">{{item.content || '[媒体]'}} </text>
      </view>
    </view>
    <view class="modal-section" wx:if="{{spaceRecentMessages.length}}">
      <view class="modal-section-head">近期消息</view>
      <view class="feed-row" wx:for="{{spaceRecentMessages}}" wx:key="id">
        <text class="feed-meta">{{item.alias || item.user_id}} · {{item.created_at}}</text>
        <text class="feed-content">{{item.content || '[媒体]'}} </text>
      </view>
    </view>
    <button class="close-button" bindtap="closeSpaceDetail">关闭</button>
  </view>
</view>

<view class="modal" wx:if="{{showLogModal}}">
  <view class="modal-content">
    <view class="modal-title" wx:if="{{logTargetType === 'space'}}">房间号 {{logSpace.code || logSpace.space_id}}@{{logSpace.owner || '未设置'}} 日志</view>
    <view class="modal-title" wx:if="{{logTargetType === 'user'}}">用户 {{logUser.alias || logUser.user_id || '未知用户'}} 日志</view>
    <view class="modal-section" wx:if="{{logEntries.length}}">
      <view class="log-row" wx:for="{{logEntries}}" wx:key="id">
        <view class="log-main">
          <text class="log-user">{{item.alias || item.user_id || '未知用户'}}</text>
          <text class="log-action">{{item.action}}</text>
        </view>
        <view class="log-meta">
          <text>{{item.page || '-'}}</text>
          <text>{{item.created_at}}</text>
        </view>
        <view class="log-detail" wx:if="{{item.detail}}">{{item.detail}}</view>
      </view>
    </view>
    <view class="log-empty" wx:if="{{logLoading}}">加载中...</view>
    <view class="log-empty" wx:if="{{!logLoading && !logEntries.length}}">暂无日志</view>
    <button class="close-button" bindtap="closeSpaceLogs">关闭</button>
  </view>
</view>
